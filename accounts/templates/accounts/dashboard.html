{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="min-h-screen bg-gray-50 p-8 flex flex-col items-center justify-start">
  <div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-6 space-y-6 animate-fadeIn">
    
    <!-- Profile Header -->
    <div class="flex items-center space-x-4">
      {% if user.avatar %}
        <img src="{{ user.avatar.url }}" alt="Avatar" class="w-20 h-20 rounded-full border-2 border-indigo-500 shadow-md transition duration-300 hover:scale-105">
      {% else %}
        <div class="w-20 h-20 rounded-full bg-gradient-to-tr from-indigo-500 to-pink-400 text-white flex items-center justify-center text-2xl font-bold">
          {{ user.first_name|default:user.email|slice:":1"|upper }}
        </div>
      {% endif %}
      <div>
        <h1 class="text-2xl font-semibold text-gray-800">Welcome back, <span id="user-first-name">{{ user.first_name|default:user.username }}</span>!</h1>
        <p class="text-gray-500 text-sm">Let's continue your journey on InsightVault 🚀</p>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="grid grid-cols-2 gap-4">
      <button id="toggle-edit-btn" class="bg-indigo-100 text-indigo-700 px-4 py-3 rounded-xl shadow hover:bg-indigo-200 transition-all font-medium">
        ✍️ Edit Profile
      </button>
      <form action="{% url 'accounts:logout' %}" method="post">
        {% csrf_token %}
        <button type="submit" class="w-full bg-red-100 text-red-700 px-4 py-3 rounded-xl shadow hover:bg-red-200 transition-all font-medium">
          🔒 Logout
        </button>
      </form>
    </div>

    <!-- Inline Edit Form (Initially Hidden) -->
    <div id="edit-profile-form" class="hidden mt-4 border-t pt-4 space-y-4">
      <form id="profileForm" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="space-y-3">
          <div>
            <label class="block text-sm text-gray-600">First Name</label>
            <input type="text" name="first_name" value="{{ user.first_name }}" class="w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring focus:border-indigo-500">
          </div>
          <div>
            <label class="block text-sm text-gray-600">Last Name</label>
            <input type="text" name="last_name" value="{{ user.last_name }}" class="w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring focus:border-indigo-500">
          </div>
          <div>
            <label class="block text-sm text-gray-600">Bio</label>
            <textarea name="bio" rows="3" class="w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring focus:border-indigo-500">{{ user.bio }}</textarea>
          </div>
          <div>
            <label class="block text-sm text-gray-600">Avatar</label>
            <input type="file" name="avatar" accept="image/*" class="w-full border px-3 py-2 rounded-lg">
          </div>
        </div>
        <button type="submit" class="mt-3 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">💾 Save Changes</button>
      </form>
    </div>

    <!-- Password Change Placeholder -->
    <div class="mt-6 text-center">
      <a href="{% url 'accounts:change_password' %}" class="text-indigo-500 hover:underline text-sm">🔑 Change Password</a>
    </div>
  </div>
</div>

<!-- AJAX Script -->
<script>
  document.getElementById("toggle-edit-btn").addEventListener("click", () => {
    const formSection = document.getElementById("edit-profile-form");
    formSection.classList.toggle("hidden");
  });

  document.getElementById("profileForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const formData = new FormData(this);
    fetch("{% url 'accounts:update_profile' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === "success") {
        document.getElementById("user-first-name").innerText = data.first_name || data.username;
        alert("Profile updated!");
      } else {
        alert("Update failed.");
      }
    });
  });
</script>
{% endblock %}
